<script setup lang="ts">
import { computed, onBeforeUnmount, onMounted, ref, watch } from 'vue';
import { useConfigStore } from '@/stores/config';
import ToggleSetting from '@/views/settings/components/ToggleSetting.vue';
import OptionCategory from './components/OptionCategory.vue';
import { useRouter } from 'vue-router';
import PrimaryButton from '../../components/Buttons/PrimaryButton.vue';
import useChatsStore from '@/stores/chatsStore';
import useMessagesStore from '@/stores/messagesStore';
import supabase from '@/lib/supabase';
import TextInputSetting from './components/TextInputSetting.vue';
import logger from '@/lib/logger';
import setPageTitle from '@/utils/core/setPageTitle';
import CategoryLabel from './components/CategoryLabel.vue';
import NumberInputSetting from './components/NumberInputSetting.vue';
import PageHeader from '@/components/Page/PageHeader.vue';
import SelectionSetting from './components/SelectionSetting.vue';
import ollamaRequest from '@/utils/ollamaRequest';
import { TbListDetails } from 'vue-icons-plus/tb';
import { useModelList } from '@/composables/useModelList';
import OptionText from './components/OptionText.vue';
import { usePWAState } from '@/composables/usePWAState';
import StatusIndicator from './components/StatusIndicator.vue';
import { BiInfoCircle, BiRocket, BiSolidKeyboard, BiTrash, BiUserCircle, BiWrench } from 'vue-icons-plus/bi';

const config = useConfigStore();
const router = useRouter();

const chatsStore = useChatsStore();
const messagesStore = useMessagesStore();
const { connectedToOllama, loading: ollamaLoading } = useModelList();
const pwaState = usePWAState();

// transition speed
const transitionSpeed = ref(0.125);
const transitionSpeedText = computed(() => {
    const speed = transitionSpeed.value;

    if (speed == 0) {
        return 'Disabled';
    } else {
        return `${speed * 1000}ms`;
    }
});

function updateTransitionSpeed() {
    const newSpeed = transitionSpeed.value;

    config.setTransitionSpeed(newSpeed);
}

function ollamaUrlCheck(url: string): string {
    if (url.length === 0 || url === "") {
        url = ollamaDefault;
    }

    config.ollamaUrl = url;
    location.reload();

    return url;
}

// clear chats
function clearChats() {
    if (!confirm('Are you sure you want to clear all chats?')) return;

    chatsStore.clearChats();
    messagesStore.clearAllMessages();
}

function handleEscape(e: KeyboardEvent) {
    if (document.activeElement?.tagName === 'BODY') {
        return;
    }

    if (e.key === 'Escape') {
        router.back();
    }
}

onMounted(async () => {
    setPageTitle('Settings');

    transitionSpeed.value = config.transitionSpeed;
    document.addEventListener('keydown', handleEscape);
});

onBeforeUnmount(() => {
    document.removeEventListener('keydown', handleEscape);
});

const inProduction = import.meta.env.VITE_PRODUCTION === 'true';
const ollamaDefault = import.meta.env.VITE_PRODUCTION ?? 'http://localhost:11434';

watch(
    () => config.api.enabled,
    async (newValue) => {
        if (newValue === false && config.api.signoutBeforeDisable) {
            // TODO: Fix/make this work
            if (!supabase) return;

            logger.info('Settings Page', 'Signing out before disabling API');
            await supabase.auth.signOut();
        }

        location.reload();
    }
);

async function checkOllamaVersion() {
    const { data: response, error } = await ollamaRequest('/api/version', 'GET');

    if (error) {
        alert(`❌ Error fetching Ollama version, ${error}`);
        return;
    }
    
    const body = await response.json();

    alert(`✅ Ollama Version: ${body.version || 'Unknown'}`);
}
</script>

<template>
    <div class="w-full h-full flex flex-col items-center py-4 box-border overflow-y-auto px-2 gap-4
    *:mx-auto *:md:w-4/5 *:lg:w-3/5 *:max-w-3xl">
        <PageHeader text="Settings" />

        <OptionCategory label="Account" v-if="inProduction">
            <ToggleSetting 
                v-model="config.api.enabled" 
                label="Enable Llamapen API" />
            <span v-if="!config.api.enabled" class="text-text-muted/80 text-sm">
                <BiRocket class="size-4 inline align-middle" />
                Run more powerful models with LlamaPen API, an optional cloud service.
            </span>
            
            <PrimaryButton
                v-else
                text="Manage Account"
                type="link" 
                to="/account" 
                :icon="BiUserCircle" />
        </OptionCategory>

        <OptionCategory label="Ollama">
            <div v-if="config.api.enabled">Ollama not available while LlamaPen API is enabled.</div>
            <template v-else>
                <TextInputSetting 
                    label="Ollama URL" 
                    v-model="config.ollamaUrl" 
                    :default="ollamaDefault"
                    :check="ollamaUrlCheck"
                    :tooltip="`The URL to connect to Ollama on. (Default: ${ollamaDefault})`" />
                <span v-if="!connectedToOllama && !ollamaLoading">
                    Can't connect? Checkout the
                    <RouterLink to="/guide" class="text-text underline">setup guide</RouterLink>.
                </span>

                <ToggleSetting
                    v-model="config.ollama.modelCapabilities.autoload"
                    label="Autoload model capabilities"
                    tooltip="Load model capabilities on connect. By default only loads if 30 models or less. (Default: Enabled)" />
                <div v-if="config.ollama.modelCapabilities.autoload" class="border-l-[1px] border-text pl-3 ml-3">
                    <ToggleSetting 
                        v-model="config.ollama.modelCapabilities.alwaysAutoload" 
                        label="Always autoload model capabilities"
                        tooltip="Loads model capabilities regardless of no. of models. (Default: Disabled)" />
                </div>

                <div class="flex flex-row gap-2 *:w-1/2">
                    <PrimaryButton
                        text="Manage Models"
                        type="link" 
                        to="/models" 
                        :icon="TbListDetails" /> 
                    <PrimaryButton
                        text="Check Ollama version"
                        type="button"
                        @click="checkOllamaVersion"
                        :icon="BiInfoCircle" />
                </div>
            </template>
        </OptionCategory>

        <OptionCategory label="Appearance">
            <PrimaryButton
                text="View keyboard shortcuts"
                type="link" 
                to="/shortcuts" 
                :icon="BiSolidKeyboard" />
            <SelectionSetting 
                v-model="config.ui.theme" 
                label="Theme" 
                :items="['auto', 'dark', 'light', 'mono-dark', 'mono-light', 'amoled']" 
                :itemNames="['System default', 'Dark', 'Light', 'Plain Dark', 'Plain Light', 'AMOLED']"
                @update:model-value="config.loadTheme()" 
                tooltip="The theme for the app. (Default: System default (dark/light))"
            />
            <ToggleSetting 
                v-model="config.ui.nativeScrollbar" 
                label="Native scrollbar" 
                tooltip="Use the browser's default scrollbar styling. (Default: Disabled)"
                @update:model-value="config.loadScrollbarSetting()"
            />
            <ToggleSetting 
                v-model="config.ui.messageInput.sendButtonAltIcon" 
                label="Alternate send button icon" 
                tooltip="Use a paper-plane icon instead of an up arrow. (Default: Disabled)"
            />
            <ToggleSetting 
                v-model="config.ui.messageInput.hideUnusedButtons" 
                label="Hide unused message input buttons" 
                tooltip="Hide buttons that rely on specific capabilities when the current model doesn't support them, such as the 'Think' button. (Default: Enabled)"
            />
            <div class="flex flex-col gap-2 w-full">
                <OptionText label="Animation Duration" tooltip="The length of animations/transitions throughout the UI. (Default: 125ms)" />
                <input class="accent-primary w-full" @change="updateTransitionSpeed" v-model="transitionSpeed"
                    type="range" min="0" max="1" step="0.025" />
                <span class="py-2">
                    <span class="border-2 border-border-muted w-fit p-2 rounded-lg cursor-default box-border">{{
                        transitionSpeedText }}</span>
                    <span class="pl-2">{{ transitionSpeed == 0.125 ? '(Default)' : '' }}</span>
                </span>
            </div>
            <CategoryLabel>Model Icons</CategoryLabel>
            <ToggleSetting 
                v-model="config.ui.modelIcons.monochrome" 
                label="Monochrome model icons"
                tooltip="Use single-color variants of model icons. (Default: Enabled)" />
            <ToggleSetting 
                v-model="config.ui.modelIcons.background" 
                label="Model icons background"
                tooltip="Add a background to model icons throughout the app. (Default: Disabled)" />
            <div v-if="config.ui.modelIcons.background" class="border-l-[1px] border-text pl-3 ml-3">
                <ToggleSetting 
                    v-model="config.ui.modelIcons.backgroundDark" 
                    label="Dark icon background"
                    tooltip="Make the icon background darker. (Default: Disabled)" />
            </div>
            <ToggleSetting 
                v-model="config.ui.modelIcons.alternateGemmaIcon" 
                label="Alternate Gemma icon"
                tooltip="Use the Google logo instead of the Gemma icon. (Default: Disabled)" />
            <CategoryLabel>Tooltip</CategoryLabel>
            <NumberInputSetting 
                v-model="config.ui.tooltip.waitTimeoutMs" 
                :default="100" 
                :min="0" 
                :max="1000"
                label="Hover delay (ms)"
                tooltip="How long to mouse over an element before it's tooltip appears. (Default: 100)" />
            <CategoryLabel>Mobile</CategoryLabel>
            <ToggleSetting 
                v-model="config.closeSidebarOnNavMobile" 
                label="Hide sidebar on navigate"
                tooltip="Hides the sidebar after pressing a button to change the page. (Default: Enabled)" />
        </OptionCategory>

        <OptionCategory label="Chat">
            <PrimaryButton
                text="Manage Tools"
                type="link" 
                to="/tools"
                :icon="BiWrench" />
            <SelectionSetting 
                v-model="config.chat.titleGenerationStyle" 
                label="Title generation style" 
                :items="['firstMessage', 'generate', 'chatId', 'dynamic']" 
                :itemNames="['Use first message', 'Generate with current model', 'Use chat ID', 'Dynamic (default)']"
                tooltip="Dynamic: First message if question, else generate. (Default: Generate with current model)"
            />
            <ToggleSetting 
                v-model="config.chat.thinking.infoOpenByDefault"
                label="Reasoning text open by default"
                tooltip="Have reasoning/thinking text open by default for each message. (Default: Disabled)" />
            <ToggleSetting 
                v-model="config.chat.hideTPSInfoText"
                label="Hide tokens/sec in message footer"
                tooltip="Hide the <num>tok/s text in the message footer/controls for model messages. (Default: Disabled)" />
            <PrimaryButton
                text="Clear all chats"
                type="button"
                color="danger"
                :icon="BiTrash"
                @click="clearChats" />
        </OptionCategory>

        <OptionCategory label="PWA">
            <StatusIndicator :state="pwaState.isOnline.value" label="Online?" />
            <StatusIndicator :state="pwaState.offlineReady.value" label="Offline ready?" />
            <StatusIndicator :state="pwaState.needRefresh.value" label="Needs refresh?" />
        </OptionCategory>

        <OptionCategory label="Developer" v-if="!inProduction">
            <span class="text-danger">Do not change these settings unless you know what you're doing.</span>
            <ToggleSetting v-model="config.developer.mockRequests" label="Mock requests" />
            <ToggleSetting v-model="config.developer.infoLogs" label="Show info logs" />
        </OptionCategory>
    </div>
</template>